# Gleam 后续开发计划

## 已完成工作回顾

### ✅ 架构重构（第一阶段）
- 创建 `AIMessageService` 统一AI请求处理逻辑
- 消除 `MessageSendHandler` 和 `RegenerateHandler` 之间约80%的重复代码
- 代码量减少：MessageSendHandler (-43%), RegenerateHandler (-37%)

### ✅ 架构重构（第二阶段）
- 创建 `ConfigService` 合并 ConfigHandler 和 ConfigManager
- 删除冗余的配置管理类
- 简化依赖注入，统一配置管理接口

### ✅ UI重构
- 全面优化消息气泡、输入区域、按钮、历史面板、模型对话框样式
- 添加平滑动画和微交互效果
- 保持清爽设计风格的同时提升视觉美感

---

## 第三阶段：状态管理优化（优先级：高）

### 目标
统一和简化状态管理，减少组件间的紧密耦合

### 具体任务

#### 1. 创建统一的状态管理服务
**文件：** `src/services/StateService.ts`

**职责：**
- 集中管理所有应用状态（当前消息、加载状态、上下文注入状态等）
- 提供状态订阅机制
- 实现状态持久化

**重构内容：**
```typescript
// 整合 ChatPanel 中分散的状态
- currentMessages: ChatMessage[]
- isLoading: { value: boolean }
- hasContextInjected: { value: boolean }
```

**预期收益：**
- 减少 props drilling
- 更容易追踪状态变化
- 便于后续实现撤销/重做功能

#### 2. 简化 PanelInitializer 依赖注入
**当前问题：** 24个参数的构造函数

**优化方案：**
- 使用依赖注入容器模式
- 将相关依赖分组到配置对象中
- 采用 Builder 模式简化初始化

**预期收益：**
- 提高代码可读性
- 降低维护成本
- 便于单元测试

---

## 第四阶段：功能增强（优先级：中）

### 1. 多轮对话管理增强
- [ ] 支持编辑历史消息
- [ ] 支持从某条消息开始重新生成
- [ ] 实现对话分支管理
- [ ] 添加消息搜索功能

### 2. 附件处理增强
- [ ] 支持更多文件类型（PDF、Word、Excel等）
- [ ] 文件预览优化
- [ ] 批量上传附件
- [ ] 附件大小限制和压缩

### 3. 模型参数配置
- [ ] 为不同模型保存独立的参数配置
- [ ] 预设参数模板（创意模式、精确模式等）
- [ ] 参数配置导入导出

### 4. 导出功能增强
- [ ] 支持导出为多种格式（PDF、HTML、Word）
- [ ] 自定义导出模板
- [ ] 导出时包含附件
- [ ] 导出历史记录管理

---

## 第五阶段：性能优化（优先级：中）

### 1. 消息渲染优化
- [ ] 实现虚拟滚动（长对话列表）
- [ ] 优化 Markdown 渲染性能
- [ ] 图片懒加载
- [ ] 代码高亮异步加载

### 2. API 请求优化
- [ ] 实现请求取消机制
- [ ] 添加请求重试逻辑
- [ ] 优化流式响应处理
- [ ] 实现请求队列管理

### 3. 存储优化
- [ ] 大型对话自动归档
- [ ] 实现存储空间管理
- [ ] 优化历史记录加载性能
- [ ] 添加数据导出/导入功能

---

## 第六阶段：用户体验提升（优先级：中）

### 1. 快捷键支持
- [ ] Ctrl/Cmd + K 快速打开模型选择
- [ ] Ctrl/Cmd + N 新建对话
- [ ] Ctrl/Cmd + H 打开历史记录
- [ ] Ctrl/Cmd + / 快捷键帮助

### 2. 主题定制
- [ ] 自定义主题色
- [ ] 预设主题模板
- [ ] 跟随系统深色/浅色模式
- [ ] 字体大小调节

### 3. 交互优化
- [ ] 消息加载骨架屏
- [ ] 更好的错误提示和恢复机制
- [ ] 离线状态检测和提示
- [ ] 操作确认对话框

### 4. 无障碍支持
- [ ] 键盘导航优化
- [ ] ARIA 标签完善
- [ ] 屏幕阅读器支持
- [ ] 高对比度模式

---

## 第七阶段：测试完善（优先级：中）

### 1. 单元测试
- [ ] 为 Services 层添加单元测试
- [ ] 为 Handlers 层添加单元测试
- [ ] 为工具函数添加测试
- [ ] 达到 80% 代码覆盖率

### 2. 集成测试
- [ ] 端到端对话流程测试
- [ ] 附件上传和处理测试
- [ ] 历史记录管理测试
- [ ] 导出功能测试

### 3. 测试工具配置
- [ ] 配置 Jest/Vitest
- [ ] 配置测试覆盖率工具
- [ ] 添加 CI/CD 测试流程
- [ ] 添加视觉回归测试

---

## 第八阶段：文档完善（优先级：低）

### 1. 开发文档
- [ ] API 文档生成（TypeDoc）
- [ ] 架构决策记录（ADR）
- [ ] 代码风格指南
- [ ] 贡献指南

### 2. 用户文档
- [ ] 功能使用指南
- [ ] 常见问题（FAQ）
- [ ] 视频教程
- [ ] 最佳实践

### 3. 部署文档
- [ ] 插件安装指南
- [ ] 配置说明
- [ ] 故障排查指南
- [ ] 更新日志

---

## 潜在的技术债务

### 1. 代码规范
- [ ] 统一命名规范（中英文混用问题）
- [ ] 完善 TypeScript 类型定义（减少 any 使用）
- [ ] 添加 ESLint 规则加强
- [ ] 添加 Prettier 格式化配置

### 2. 依赖管理
- [ ] 升级过时的依赖包
- [ ] 移除未使用的依赖
- [ ] 审查安全漏洞
- [ ] 优化 bundle 大小

### 3. 错误处理
- [ ] 统一错误处理机制
- [ ] 添加错误边界组件
- [ ] 实现错误日志上报
- [ ] 改进用户友好的错误提示

---

## 实施建议

### 优先级排序
1. **高优先级：** 状态管理优化（影响后续所有开发）
2. **中优先级：** 功能增强、性能优化、用户体验
3. **低优先级：** 文档完善

### 迭代方式
- 每个阶段分为多个小迭代
- 每次迭代都要确保代码可运行
- 每完成一个功能立即测试
- 定期 code review 和重构

### 质量保证
- 每次重构后运行 lint 和 build
- 手动测试核心功能
- 记录破坏性更改
- 保持向后兼容性

---

## 性能指标目标

- [ ] 首次加载时间 < 1s
- [ ] 消息渲染延迟 < 50ms
- [ ] 流式响应首字节延迟 < 200ms
- [ ] 内存占用 < 100MB
- [ ] Bundle 大小 < 150KB

---

## 长期愿景

### 社区建设
- 开源协作模式
- 插件生态系统
- 用户反馈收集机制

### 技术演进
- 考虑使用现代框架（React/Vue/Svelte）
- 探索 WebAssembly 优化性能
- 支持多语言国际化
- 云端同步功能

---

**文档更新时间：** 2025-12-16
**当前版本：** v0.1.4
**下一个里程碑：** v0.2.0（状态管理优化）
